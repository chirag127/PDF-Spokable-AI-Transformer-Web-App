name: Apex CI Pipeline - PDF Transformer

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Define the execution environment based on the JavaScript/Web App context
jobs:
  build_and_test:
    name: Build, Lint & Unit Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Node.js (2025 Standard)
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Using a stable LTS version for 2025 context
        cache: 'npm'

    - name: Install Dependencies (Using npm for JS project)
      run: npm ci

    - name: Run Linter & Formatter (Biome Check)
      # Biome is chosen for speed and modern JS/TS linting compliance
      run: npx @biomejs/biome check --no-errors-on-warnings . --formatter-check=true

    - name: Run Unit Tests (Vitest)
      # Assuming Vitest is configured for client-side/Node environment testing
      run: npx vitest:test --coverage

    - name: Upload Coverage Reports
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  e2e_verification:
    name: E2E Verification (Playwright)
    needs: build_and_test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install Dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run End-to-End Tests
      # Assuming standard setup for running Playwright tests
      run: npx playwright test --project=chromium

  deploy:
    name: Deploy Artifact (If Main Branch)
    if: github.ref == 'refs/heads/main'
    needs: [build_and_test, e2e_verification]
    runs-on: ubuntu-latest

    steps:
    - name: Archive Built Assets
      uses: actions/upload-artifact@v4
      with:
        name: pdf-transformer-build-asset
        path: dist/ # Assuming Vite builds output to 'dist'
        retention-days: 5

    - name: Deployment Placeholder
      run: |
        echo "Deployment to staging/production environments would occur here."
        echo "Using context-aware secrets management for cloud providers..."
